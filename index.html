<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retro Booth | Vintage Analogue Photobooth</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- CSS VARIABLES & THEME --- */
        :root {
            --bg-cream: #F7EFE2;
            --bg-paper: #f0e6d2;
            --sepia-dark: #4e342e;
            --sepia-light: #8d6e63;
            --accent-gold: #c5a059;
            --black-muted: #2c2c2c;
            --film-border: #1a1a1a;
            --shadow-soft: 0 4px 20px rgba(78, 52, 46, 0.15);
            --shadow-hard: 2px 2px 0px rgba(78, 52, 46, 0.3);
            --font-head: 'Playfair Display', serif;
            --font-body: 'Inter', sans-serif;
            --radius: 8px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--bg-cream);
            font-family: var(--font-body);
            color: var(--black-muted);
            overflow-x: hidden;
            min-height: 100vh;
            /* Paper texture effect */
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
        }

        /* --- FILM GRAIN OVERLAY --- */
        .film-grain {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 9999;
            opacity: 0.05;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        /* --- NAVIGATION --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(78, 52, 46, 0.1);
            position: relative;
            background: rgba(247, 239, 226, 0.9);
            backdrop-filter: blur(5px);
            z-index: 100;
        }

        .logo {
            font-family: var(--font-head);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--sepia-dark);
            letter-spacing: -0.02em;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        nav ul {
            display: flex;
            gap: 2rem;
            list-style: none;
        }

        nav a {
            text-decoration: none;
            color: var(--black-muted);
            font-weight: 500;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: color 0.3s;
        }

        nav a:hover, nav a.active { color: var(--sepia-dark); text-decoration: underline; text-decoration-thickness: 2px; text-underline-offset: 4px; }

        .banner {
            background-color: var(--sepia-dark);
            color: var(--bg-cream);
            text-align: center;
            padding: 0.5rem;
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.05em;
        }

        /* --- BUTTONS --- */
        .btn {
            background: var(--sepia-dark);
            color: var(--bg-cream);
            border: none;
            padding: 0.8rem 2rem;
            font-family: var(--font-head);
            font-size: 1.1rem;
            cursor: pointer;
            border-radius: 4px;
            box-shadow: 3px 3px 0px rgba(0,0,0,0.2);
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .btn:active { transform: translate(2px, 2px); box-shadow: 1px 1px 0px rgba(0,0,0,0.2); }
        .btn-outline { background: transparent; border: 2px solid var(--sepia-dark); color: var(--sepia-dark); box-shadow: none; }
        .btn-icon { padding: 0.5rem; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }

        /* --- PAGES --- */
        .page { display: none; padding: 2rem; max-width: 1200px; margin: 0 auto; animation: fadeIn 0.5s ease; }
        .page.active { display: block; }

        /* --- HOME --- */
        .hero { text-align: center; padding: 4rem 1rem; }
        .hero h1 { font-family: var(--font-head); font-size: 4rem; color: var(--sepia-dark); margin-bottom: 1rem; line-height: 1.1; }
        .hero p { font-size: 1.2rem; color: var(--sepia-light); margin-bottom: 3rem; font-style: italic; }
        .polaroid-stack { display: flex; justify-content: center; gap: 1rem; margin-top: 3rem; flex-wrap: wrap; }
        .dummy-polaroid {
            background: white; padding: 10px 10px 30px 10px; width: 150px; height: 180px;
            box-shadow: var(--shadow-soft); transform: rotate(-5deg); border: 1px solid #ddd;
        }
        .dummy-polaroid:nth-child(2) { transform: rotate(3deg); }
        .dummy-polaroid:nth-child(3) { transform: rotate(-2deg); }
        .dummy-inner { background: #333; height: 100%; width: 100%; opacity: 0.8; }

        /* --- BOOTH UI --- */
        .booth-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
            height: 80vh;
        }

        .controls-panel {
            background: white;
            padding: 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-soft);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            border: 1px solid #e0d0b8;
        }

        .control-group h3 { font-family: var(--font-head); margin-bottom: 0.8rem; font-size: 1.2rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem; }
        
        .layout-options, .filter-options { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        
        .option-btn {
            border: 1px solid #ccc; background: #fff; padding: 0.5rem; cursor: pointer; border-radius: 4px; flex: 1; text-align: center;
            font-size: 0.8rem; transition: all 0.2s;
        }
        .option-btn.selected { background: var(--sepia-dark); color: white; border-color: var(--sepia-dark); }
        .option-btn i { font-size: 1.2rem; display: block; margin-bottom: 4px; }

        /* Frame Options Styling */
        .frame-options {
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
            padding: 5px 0;
            justify-content: center;
        }

        .frame-radio {
            display: none; /* Hide default radio */
        }

        .frame-label {
            position: relative;
            cursor: pointer;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid #ddd;
            transition: transform 0.2s, border-color 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            background-size: cover;
            background-position: center;
        }

        .frame-label:hover { transform: scale(1.1); }

        .frame-radio:checked + .frame-label {
            border-color: var(--sepia-dark);
            box-shadow: 0 0 0 2px white, 0 0 0 5px var(--sepia-dark);
            transform: scale(1.1);
        }

        /* Frame Preview Images (Dynamically set via JS or style tags below) */
        
        .viewfinder-area {
            position: relative;
            background: #111;
            border-radius: var(--radius);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
            border: 8px solid #333;
        }

        video {
            width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); /* Mirror */
        }

        /* Video Filters (Preview Only) */
        .filter-sepia video { filter: sepia(0.6) contrast(1.1) brightness(0.9); }
        .filter-bw video { filter: grayscale(1) contrast(1.2); }
        .filter-warm video { filter: sepia(0.3) saturate(1.4) contrast(1.1); }
        .filter-vintage video { filter: sepia(0.4) grayscale(0.2) contrast(1.1) brightness(0.9); }
        .filter-none video { filter: none; }

        .countdown-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-family: var(--font-head); font-size: 8rem; color: white; text-shadow: 0 4px 10px rgba(0,0,0,0.5);
            display: none; pointer-events: none;
        }

        .flash-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white;
            opacity: 0; pointer-events: none;
        }

        .camera-actions {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 10;
        }
        
        .shutter-btn {
            width: 70px; height: 70px; border-radius: 50%; background: #c62828; border: 4px solid white;
            box-shadow: 0 0 20px rgba(0,0,0,0.5); cursor: pointer; transition: transform 0.1s;
        }
        .shutter-btn:active { transform: translateX(-50%) scale(0.9); }

        /* --- RESULT/GALLERY --- */
        .result-container { text-align: center; }
        .result-stage {
            max-width: 600px; margin: 0 auto; background: transparent; padding: 20px;
            box-shadow: none; transform: none;
        }
        #resultCanvas { max-width: 100%; height: auto; box-shadow: 0 8px 30px rgba(0,0,0,0.25); }
        
        .gallery-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 2rem; margin-top: 2rem;
        }
        .gallery-item {
            position: relative; background: transparent; padding: 0;
            transition: transform 0.2s;
            cursor: pointer;
        }
        .gallery-item:hover { transform: scale(1.02) rotate(1deg); z-index: 10; }
        .gallery-item img { width: 100%; display: block; box-shadow: var(--shadow-soft); }
        
        .delete-btn {
            position: absolute; top: -10px; right: -10px; background: #c62828; color: white;
            width: 25px; height: 25px; border-radius: 50%; border: none; cursor: pointer; display: none; z-index: 20;
        }
        .gallery-item:hover .delete-btn { display: block; }

        /* --- STICKERS --- */
        .sticker-tray {
            display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; border-top: 1px solid #eee; margin-top: auto;
        }
        .sticker-opt { font-size: 1.5rem; cursor: pointer; padding: 5px; opacity: 0.7; transition: opacity 0.2s; }
        .sticker-opt:hover { opacity: 1; transform: scale(1.2); }

        /* --- ABOUT PAGE STYLES --- */
        .about-content {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 3rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-soft);
            border: 1px solid #e0d0b8;
        }
        .about-section { margin-bottom: 2.5rem; }
        .about-section h2 { font-family: var(--font-head); font-size: 2rem; color: var(--sepia-dark); margin-bottom: 1rem; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .about-section p { font-size: 1.05rem; line-height: 1.6; color: var(--black-muted); margin-bottom: 1rem; }
        .feature-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-top: 2rem; }
        .feature-card { text-align: center; padding: 1.5rem; background: var(--bg-cream); border-radius: var(--radius); border: 1px solid rgba(0,0,0,0.05); }
        .feature-card i { font-size: 2rem; color: var(--sepia-light); margin-bottom: 1rem; }
        .feature-card h4 { font-family: var(--font-head); margin-bottom: 0.5rem; font-size: 1.1rem; }
        .feature-card p { font-size: 0.9rem; margin: 0; }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        
        @keyframes flash {
            0% { opacity: 0; } 10% { opacity: 1; } 100% { opacity: 0; }
        }
        .flash-active { animation: flash 0.4s ease-out; }
        
        @keyframes count {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }
        .count-anim { animation: count 0.9s ease-in-out; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            .booth-container { grid-template-columns: 1fr; height: auto; }
            .controls-panel { order: 2; }
            .viewfinder-area { height: 60vh; order: 1; }
            header { flex-direction: column; gap: 1rem; }
            nav ul { gap: 1rem; font-size: 0.8rem; }
            .hero h1 { font-size: 2.5rem; }
            .about-content { padding: 1.5rem; }
        }
    </style>
</head>
<body>

    <div class="film-grain"></div>

    <div class="banner">
        Enjoy your Photobooth
    </div>

    <header>
        <div class="logo">
            <i class="fa-solid fa-camera-retro"></i>
            <span>RETRO BOOTH</span>
        </div>
        <nav>
            <ul>
                <li><a href="#" onclick="navTo('home')" class="active">Home</a></li>
                <li><a href="#" onclick="navTo('booth')">Booth</a></li>
                <li><a href="#" onclick="navTo('gallery')">Gallery</a></li>
                <li><a href="#" onclick="navTo('about')">About</a></li>
            </ul>
        </nav>
    </header>

    <!-- HOME PAGE -->
    <main id="home-page" class="page active">
        <div class="hero">
            <h1>Capture Moments<br>Like It's 1970's.</h1>
            <p>Digital photography with an analogue soul.</p>
            <button class="btn" onclick="navTo('booth')">START BOOTH</button>

            <div class="polaroid-stack">
                <div class="dummy-polaroid"><div class="dummy-inner"></div></div>
                <div class="dummy-polaroid"><div class="dummy-inner"></div></div>
                <div class="dummy-polaroid"><div class="dummy-inner"></div></div>
            </div>
        </div>
    </main>

    <!-- BOOTH PAGE -->
    <main id="booth-page" class="page">
        <div class="booth-container">
            <!-- Sidebar Controls -->
            <div class="controls-panel">
                <div class="control-group">
                    <h3>1. Choose Layout</h3>
                    <div class="layout-options">
                        <div class="option-btn selected" onclick="setLayout('strip')" id="btn-strip">
                            <i class="fa-solid fa-film"></i> Strip
                        </div>
                        <div class="option-btn" onclick="setLayout('grid')" id="btn-grid">
                            <i class="fa-solid fa-border-all"></i> 2x2
                        </div>
                        <div class="option-btn" onclick="setLayout('single')" id="btn-single">
                            <i class="fa-regular fa-image"></i> Single
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <h3>2. Set Filter</h3>
                    <div class="filter-options">
                        <div class="option-btn" onclick="setFilter('none')">Normal</div>
                        <div class="option-btn selected" onclick="setFilter('sepia')">Sepia</div>
                        <div class="option-btn" onclick="setFilter('bw')">B&W</div>
                        <div class="option-btn" onclick="setFilter('vintage')">Vintage</div>
                    </div>
                </div>

                <div class="control-group">
                    <h3>3. Select Frame</h3>
                    <div class="frame-options" id="frame-options-container">
                        <!-- Injected via JS -->
                    </div>
                </div>
            </div>

            <!-- Camera Viewfinder -->
            <div class="viewfinder-area filter-sepia" id="viewfinder">
                <video id="webcam" autoplay playsinline muted></video>
                <div class="flash-overlay" id="flash"></div>
                <div class="countdown-overlay" id="countdown">3</div>
                
                <div class="camera-actions">
                    <button class="shutter-btn" onclick="startCaptureSequence()"></button>
                </div>
            </div>
        </div>
    </main>

    <!-- RESULT PAGE -->
    <main id="result-page" class="page">
        <div class="result-container">
            <h2 style="font-family: var(--font-head); margin-bottom: 1rem;">Your Photo is Ready</h2>
            
            <div class="result-stage">
                <canvas id="resultCanvas"></canvas>
            </div>

            <div class="controls-panel" style="margin-top: 2rem; max-width: auto; margin-left: auto; margin-right: auto;">
                <div style="gap: 10px; text-align: center; margin: 1rem;">
                    <button class="btn btn-outline" onclick="retake()">Retake</button>
                    <button class="btn btn-outline" onclick="downloadImage()">Download</button>
                    <button class="btn btn-outline" onclick="saveToGallery()">Save to Gallery</button>
                </div>
            </div>
        </div>
    </main>

    <!-- GALLERY PAGE -->
    <main id="gallery-page" class="page">
        <h2 style="font-family: var(--font-head); text-align: center;">Photo Archive</h2>
        <div class="gallery-grid" id="gallery-grid">
            <!-- Items injected via JS -->
        </div>
        <div style="text-align: center; margin-top: 3rem;">
            <button class="btn btn-outline" onclick="localStorage.removeItem('retroPhotos'); loadGallery();">Clear All History</button>
        </div>
    </main>

    <!-- ABOUT PAGE -->
    <main id="about-page" class="page">
        <div class="about-content">
            <div class="about-section">
                <h2>Our Story</h2>
                <p>Welcome to Retro Booth. In an age where every photo is instantly editable and perfect, we wanted to bring back the magic of waiting, the charm of imperfection, and the soul of analogue photography.</p>
                <p>Inspired by the classic mall photobooths of the 70s and 80s, this digital experience replicates the grain, the flash, and the spontaneity of the physical booths we all miss.</p>
            </div>

            <div class="about-section">
                <h2>How It Works</h2>
                <div class="feature-grid">
                    <div class="feature-card">
                        <i class="fa-solid fa-camera"></i>
                        <h4>Snap</h4>
                        <p>Choose your layout (strip or grid) and get ready for the flash sequence.</p>
                    </div>
                    <div class="feature-card">
                        <i class="fa-solid fa-wand-magic-sparkles"></i>
                        <h4>Process</h4>
                        <p>We apply our custom film grain and color grading algorithms instantly.</p>
                    </div>
                    <div class="feature-card">
                        <i class="fa-solid fa-download"></i>
                        <h4>Keep</h4>
                        <p>Save your digital strip to your device or keep it in your browser gallery.</p>
                    </div>
                </div>
            </div>

            <div class="about-section" style="border-bottom: none;">
                <h2>Privacy</h2>
                <p><strong>Your photos never leave your device.</strong> All image processing happens locally in your browser. We do not store, upload, or see any of the photos you take here. Your gallery is saved to your browser's local storage.</p>
                <div style="text-align: center; margin-top: 2rem;">
                    <button class="btn" onclick="navTo('booth')">Start Snapping</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        /* --- FRAME ASSETS (SVG Data URIs) --- */
        // These are self-contained background patterns
        const frameAssets = [
            {
                id: 'simple-white',
                name: 'Classic White',
                // Subtle paper texture
                src: `data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='100' height='100' fill='%23fdfbf7'/%3E%3C/svg%3E`
            },
            {
                id: 'evil-eye',
                name: 'Evil Eye', // I renamed this from 'Classic White' to match the design
                // Below is the URL-encoded version of the SVG generated in the previous step
                src: `data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='100' height='100' fill='%23fdfbf7'/%3E%3Cg%3E%3Ccircle cx='50' cy='50' r='25' fill='%231A3C8C'/%3E%3Ccircle cx='50' cy='50' r='15' fill='%2387CEEB'/%3E%3Ccircle cx='50' cy='50' r='10' fill='%23FFFFFF'/%3E%3Ccircle cx='50' cy='50' r='5' fill='%23000000'/%3E%3C/g%3E%3Cg%3E%3Ccircle cx='15' cy='20' r='20' fill='%231A3C8C'/%3E%3Ccircle cx='15' cy='20' r='12' fill='%2387CEEB'/%3E%3Ccircle cx='15' cy='20' r='8' fill='%23FFFFFF'/%3E%3Ccircle cx='15' cy='20' r='4' fill='%23000000'/%3E%3C/g%3E%3Cg%3E%3Ccircle cx='85' cy='25' r='22' fill='%231A3C8C'/%3E%3Ccircle cx='85' cy='25' r='13' fill='%2387CEEB'/%3E%3Ccircle cx='85' cy='25' r='9' fill='%23FFFFFF'/%3E%3Ccircle cx='85' cy='25' r='4.5' fill='%23000000'/%3E%3C/g%3E%3Cg%3E%3Ccircle cx='25' cy='80' r='24' fill='%231A3C8C'/%3E%3Ccircle cx='25' cy='80' r='14' fill='%2387CEEB'/%3E%3Ccircle cx='25' cy='80' r='9.5' fill='%23FFFFFF'/%3E%3Ccircle cx='25' cy='80' r='4.8' fill='%23000000'/%3E%3C/g%3E%3Cg%3E%3Ccircle cx='75' cy='75' r='23' fill='%231A3C8C'/%3E%3Ccircle cx='75' cy='75' r='13.5' fill='%2387CEEB'/%3E%3Ccircle cx='75' cy='75' r='9' fill='%23FFFFFF'/%3E%3Ccircle cx='75' cy='75' r='4.6' fill='%23000000'/%3E%3C/g%3E%3C/svg%3E`
            },
            {
                id: 'retro-stripes',
                name: 'Retro Stripes',
                // Vertical stripes
                src: `data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='40' height='40' fill='%23fce4ec'/%3E%3Cpath d='M0 0h10v40H0zm20 0h10v40H20z' fill='%23f8bbd0' fill-opacity='0.6'/%3E%3C/svg%3E`
            },
            {
                id: 'blue-geo',
                name: 'Cool Geo',
                // Blue geometric pattern
                src: `data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='60' height='60' fill='%23e1f5fe'/%3E%3Cpath d='M0 0l30 30L0 60zM60 0L30 30l30 30z' fill='%23b3e5fc' fill-opacity='0.5'/%3E%3C/svg%3E`
            },
            {
                id: 'pink-impasto',
                name: 'Pink Hearts', 
                // Recreating bg7 (Pink textured hearts)
                src: `data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='100' height='100' fill='%23dbc3d0'/%3E%3Cpath d='M30 30 Q30 10 50 25 Q70 10 70 30 Q70 50 50 70 Q30 50 30 30' fill='%23a64b6b' stroke='%23bf6b8a' stroke-width='2'/%3E%3Cpath d='M-20 80 Q-20 60 0 75 Q20 60 20 80 Q20 100 0 120 Q-20 100 -20 80' fill='%23a64b6b' stroke='%23bf6b8a' stroke-width='2'/%3E%3Cpath d='M80 80 Q80 60 100 75 Q120 60 120 80 Q120 100 100 120 Q80 100 80 80' fill='%23a64b6b' stroke='%23bf6b8a' stroke-width='2'/%3E%3C/svg%3E`
            },
            {
                id: 'boho-leaves',
                name: 'Boho Leaves',
                // Recreating bg3 (Abstract leaves)
                src: `data:image/svg+xml,%3Csvg width='120' height='120' viewBox='0 0 120 120' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='120' height='120' fill='%23e8e6da'/%3E%3Cpath d='M60 120 C 30 100 10 60 60 10 C 110 60 90 100 60 120 Z' fill='%23a65e44' opacity='0.9'/%3E%3Cpath d='M60 120 L 60 20' stroke='%23e8e6da' stroke-width='2'/%3E%3C/svg%3E`
            },
            {
                id: 'love-script',
                name: 'Love Script',
                // Recreating bg10 (Repeated text)
                src: `data:image/svg+xml,%3Csvg width='100' height='50' viewBox='0 0 100 50' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='100' height='50' fill='%23f2efe9'/%3E%3Ctext x='50' y='35' font-family='cursive' font-weight='bold' font-size='30' text-anchor='middle' fill='%23b31b1b'%3Elove%3C/text%3E%3C/svg%3E`
            },
            {
                id: 'sketch-hearts',
                name: 'Sketch Hearts',
                // Recreating bg6 (Tiny scribbled hearts)
                src: `data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='60' height='60' fill='%23f7f7f7'/%3E%3Cg fill='none' stroke='%23ff8da1' stroke-width='2' stroke-linecap='round'%3E%3Cpath d='M10 10 q-5-5 0-10 q5 5 5 10 q-5 5-5-10' transform='scale(0.8)'/%3E%3Cpath d='M40 30 q-5-5 0-10 q5 5 5 10 q-5 5-5-10' transform='scale(1)'/%3E%3Cpath d='M20 50 q-5-5 0-10 q5 5 5 10 q-5 5-5-10' transform='scale(0.9)'/%3E%3C/g%3E%3C/svg%3E`
            },
            {
                id: 'kraft-red',
                name: 'Kraft Love',
                // Recreating bg9 (Brown paper red hearts)
                src: `data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='80' height='80' fill='%23d4bda5'/%3E%3Cg fill='%239e1b1b'%3E%3Cpath d='M10 20 Q10 10 20 20 Q30 10 30 20 Q30 30 20 40 Q10 30 10 20' transform='scale(0.5)'/%3E%3Cpath d='M90 60 Q90 50 100 60 Q110 50 110 60 Q110 70 100 80 Q90 70 90 60' transform='scale(0.5)'/%3E%3Cpath d='M60 90 Q60 80 70 90 Q80 80 80 90 Q80 100 70 110 Q60 100 60 90' transform='scale(0.6)'/%3E%3C/g%3E%3C/svg%3E`
            },
            {
                id: 'blue-plaid',
                name: 'Blue Plaid',
                // Recreating bg11 (Blue grid)
                src: `data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='100' height='100' fill='%23ffffff'/%3E%3Crect x='0' y='20' width='100' height='15' fill='%23add8e6' opacity='0.6'/%3E%3Crect x='0' y='60' width='100' height='15' fill='%23add8e6' opacity='0.6'/%3E%3Crect x='20' y='0' width='15' height='100' fill='%2387cefa' opacity='0.6'/%3E%3Crect x='60' y='0' width='15' height='100' fill='%2387cefa' opacity='0.6'/%3E%3C/svg%3E`
            },
            {
                id: 'retro-choco',
                name: 'Choco Swirl',
                // Recreating bg2 (Retro brown hearts)
                src: `data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='100' height='100' fill='%234e342e'/%3E%3Cpath d='M50 90 Q10 60 10 30 A20 20 0 0 1 50 30 A20 20 0 0 1 90 30 Q90 60 50 90' fill='none' stroke='%238d6e63' stroke-width='8'/%3E%3Cpath d='M50 90 Q10 60 10 30 A20 20 0 0 1 50 30 A20 20 0 0 1 90 30 Q90 60 50 90' fill='none' stroke='%23d7ccc8' stroke-width='3' transform='scale(0.6) translate(35 35)'/%3E%3C/svg%3E`
            },
            {
                id: 'line-leaves',
                name: 'Line Art',
                // Recreating bg5 (Minimalist leaves)
                src: `data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='100' height='100' fill='%23f5f0eb'/%3E%3Cpath d='M50 100 Q50 50 90 10' fill='none' stroke='%23a1887f' stroke-width='1.5'/%3E%3Cpath d='M50 80 Q70 60 80 40' fill='none' stroke='%23a1887f' stroke-width='1'/%3E%3Cpath d='M50 60 Q30 40 20 20' fill='none' stroke='%23a1887f' stroke-width='1'/%3E%3C/svg%3E`
            },
            {
                id: 'gold-speckle',
                name: 'Gold Dust',
                // Gold specs on cream
                src: `data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='80' height='80' fill='%23fff8e1'/%3E%3Ccircle cx='10' cy='10' r='2' fill='%23ffecb3'/%3E%3Ccircle cx='50' cy='40' r='3' fill='%23ffe082'/%3E%3Ccircle cx='20' cy='60' r='2' fill='%23ffecb3'/%3E%3Ccircle cx='70' cy='20' r='2' fill='%23ffe082'/%3E%3C/svg%3E`
            },
            {
                id: 'cow-print',
                name: 'Moo Print',
                // Trendy Cow Pattern
                src: `data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='100' height='100' fill='%23ffffff'/%3E%3Cpath d='M10 10 Q20 0 30 10 Q40 20 30 30 Q20 40 10 30 Q0 20 10 10' fill='%23000000'/%3E%3Cpath d='M60 50 Q75 40 85 55 Q90 70 75 80 Q60 90 50 75 Q45 60 60 50' fill='%23000000'/%3E%3Cpath d='M80 10 Q95 5 100 20 L100 0 L80 0 Z' fill='%23000000'/%3E%3Cpath d='M10 80 Q25 70 35 85 Q40 95 30 100 L0 100 L0 90 Z' fill='%23000000'/%3E%3C/svg%3E`
            },
            {
                id: 'dreamy-clouds',
                name: 'Dreamy Sky',
                // Soft blue sky with white clouds
                src: `data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='100' height='100' fill='%2389CFF0'/%3E%3Cg fill='%23ffffff' opacity='0.8'%3E%3Ccircle cx='20' cy='30' r='10'/%3E%3Ccircle cx='35' cy='35' r='12'/%3E%3Ccircle cx='10' cy='35' r='8'/%3E%3Ccircle cx='25' cy='40' r='10'/%3E%3C/g%3E%3Cg fill='%23ffffff' opacity='0.8' transform='translate(50, 40)'%3E%3Ccircle cx='20' cy='30' r='10'/%3E%3Ccircle cx='35' cy='35' r='12'/%3E%3Ccircle cx='10' cy='35' r='8'/%3E%3Ccircle cx='25' cy='40' r='10'/%3E%3C/g%3E%3C/svg%3E`
            },
            {
                id: 'retro-checkers',
                name: 'Vans Check',
                // Classic Black & White Checkers
                src: `data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='40' height='40' fill='%23ffffff'/%3E%3Crect width='20' height='20' fill='%231a1a1a'/%3E%3Crect x='20' y='20' width='20' height='20' fill='%231a1a1a'/%3E%3C/svg%3E`
            },
            {
                id: 'groovy-waves',
                name: '70s Groovy',
                // Orange and yellow wavy lines
                src: `data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='100' height='100' fill='%23fefae0'/%3E%3Cpath d='M0 20 Q25 40 50 20 T100 20' fill='none' stroke='%23e76f51' stroke-width='5'/%3E%3Cpath d='M0 40 Q25 60 50 40 T100 40' fill='none' stroke='%23f4a261' stroke-width='5'/%3E%3Cpath d='M0 60 Q25 80 50 60 T100 60' fill='none' stroke='%23e9c46a' stroke-width='5'/%3E%3Cpath d='M0 80 Q25 100 50 80 T100 80' fill='none' stroke='%232a9d8f' stroke-width='5'/%3E%3C/svg%3E`
            },
            {
                id: 'happy-daisies',
                name: 'Daisy Field',
                // Green background with simple white flowers
                src: `data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='60' height='60' fill='%23a7c957'/%3E%3Cg transform='translate(30,30)'%3E%3Ccircle r='5' fill='%23ffe66d'/%3E%3Ccircle cx='0' cy='-8' r='4' fill='%23fff'/%3E%3Ccircle cx='6' cy='-5' r='4' fill='%23fff'/%3E%3Ccircle cx='7' cy='3' r='4' fill='%23fff'/%3E%3Ccircle cx='3' cy='8' r='4' fill='%23fff'/%3E%3Ccircle cx='-5' cy='7' r='4' fill='%23fff'/%3E%3Ccircle cx='-8' cy='0' r='4' fill='%23fff'/%3E%3Ccircle cx='-6' cy='-6' r='4' fill='%23fff'/%3E%3C/g%3E%3C/svg%3E`
            },
            {
                id: 'cottage-shrooms',
                name: 'Mushrooms',
                // Cream bg with cute red mushrooms
                src: `data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='60' height='60' fill='%23fefcf5'/%3E%3Cg transform='translate(15,35)'%3E%3Crect x='7' y='10' width='6' height='8' fill='%23e6dac8'/%3E%3Cpath d='M0 10 Q10 -5 20 10' fill='%23d9534f'/%3E%3Ccircle cx='6' cy='5' r='1.5' fill='white'/%3E%3Ccircle cx='14' cy='6' r='1' fill='white'/%3E%3C/g%3E%3Cg transform='translate(40,15) scale(0.8)'%3E%3Crect x='7' y='10' width='6' height='8' fill='%23e6dac8'/%3E%3Cpath d='M0 10 Q10 -5 20 10' fill='%23d9534f'/%3E%3Ccircle cx='10' cy='4' r='1.5' fill='white'/%3E%3C/g%3E%3C/svg%3E`
            },
            {
                id: 'cherry-bomb',
                name: 'Cherry Bomb',
                // Soft pink with red cherries
                src: `data:image/svg+xml,%3Csvg width='50' height='50' viewBox='0 0 50 50' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='50' height='50' fill='%23ffeef2'/%3E%3Cg transform='translate(15,15)'%3E%3Cpath d='M10 5 Q15 0 20 5 L20 15' stroke='%234caf50' fill='none' stroke-width='1.5'/%3E%3Cpath d='M10 5 L5 15' stroke='%234caf50' fill='none' stroke-width='1.5'/%3E%3Ccircle cx='5' cy='18' r='4' fill='%23e91e63'/%3E%3Ccircle cx='20' cy='18' r='4' fill='%23e91e63'/%3E%3C/g%3E%3C/svg%3E`
            },
            {
                id: 'fresh-lemons',
                name: 'Lemonade',
                // Mint green with yellow lemons
                src: `data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='60' height='60' fill='%23e0f2f1'/%3E%3Cg transform='translate(10,10) rotate(45)'%3E%3Cellipse cx='15' cy='10' rx='10' ry='7' fill='%23ffeb3b'/%3E%3Ccircle cx='5' cy='10' r='1' fill='%23fbc02d'/%3E%3Ccircle cx='25' cy='10' r='1' fill='%23fbc02d'/%3E%3Cpath d='M15 3 Q20 0 25 3' fill='none' stroke='%234caf50' stroke-width='2'/%3E%3Cpath d='M15 3 Q10 0 15 -5 Q20 0 15 3' fill='%238bc34a'/%3E%3C/g%3E%3C/svg%3E`
            },

            // --- Y2K & RETRO ---
            {
                id: 'y2k-butterflies',
                name: 'Fairycore',
                // Lilac with purple butterflies
                src: `data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='80' height='80' fill='%23f3e5f5'/%3E%3Cg transform='translate(20,20)'%3E%3Cellipse cx='10' cy='10' rx='6' ry='8' fill='%23ba68c8' transform='rotate(-30 10 10)'/%3E%3Cellipse cx='22' cy='10' rx='6' ry='8' fill='%23ba68c8' transform='rotate(30 22 10)'/%3E%3Cellipse cx='12' cy='20' rx='4' ry='6' fill='%23ab47bc' transform='rotate(-15 12 20)'/%3E%3Cellipse cx='20' cy='20' rx='4' ry='6' fill='%23ab47bc' transform='rotate(15 20 20)'/%3E%3Crect x='15' y='8' width='2' height='16' rx='1' fill='%234a148c'/%3E%3C/g%3E%3C/svg%3E`
            },
            {
                id: 'retro-smiley',
                name: 'Happy Vibes',
                // Yellow check with smileys
                src: `data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='60' height='60' fill='%23fff9c4'/%3E%3Ccircle cx='30' cy='30' r='12' fill='%23ffeb3b'/%3E%3Ccircle cx='26' cy='28' r='1.5' fill='%23000'/%3E%3Ccircle cx='34' cy='28' r='1.5' fill='%23000'/%3E%3Cpath d='M26 34 Q30 38 34 34' stroke='%23000' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E`
            },
            {
                id: 'yin-yang-90s',
                name: '90s Balance',
                // Purple background with Yin Yangs
                src: `data:image/svg+xml,%3Csvg width='50' height='50' viewBox='0 0 50 50' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='50' height='50' fill='%23e1bee7'/%3E%3Cg transform='translate(15,15)'%3E%3Ccircle cx='10' cy='10' r='10' fill='white'/%3E%3Cpath d='M10 0 A10 10 0 0 1 10 20 A5 5 0 0 1 10 10 A5 5 0 0 0 10 0' fill='black'/%3E%3Ccircle cx='10' cy='5' r='1.5' fill='white'/%3E%3Ccircle cx='10' cy='15' r='1.5' fill='black'/%3E%3C/g%3E%3C/svg%3E`
            },

            // --- AESTHETIC & TEXTURE ---
            {
                id: 'terrazzo-stone',
                name: 'Terrazzo',
                // Modern stone speckles
                src: `data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='100' height='100' fill='%23f0f0f0'/%3E%3Cpath d='M10 10 L20 15 L15 25 L5 20 Z' fill='%23ef9a9a'/%3E%3Cpath d='M40 50 L50 40 L60 55 Z' fill='%2390caf9'/%3E%3Cpath d='M70 10 L80 10 L85 20 L75 25 Z' fill='%23a5d6a7'/%3E%3Cpath d='M20 70 L30 80 L10 85 Z' fill='%23ffcc80'/%3E%3Ccircle cx='50' cy='80' r='4' fill='%23bcaaa4'/%3E%3C/svg%3E`
            },
            {
                id: 'midnight-stars',
                name: 'Galaxy',
                // Dark blue with gold stars
                src: `data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='80' height='80' fill='%231a237e'/%3E%3Cpath d='M40 20 L42 26 L48 26 L43 30 L45 36 L40 32 L35 36 L37 30 L32 26 L38 26 Z' fill='%23fff176'/%3E%3Ccircle cx='15' cy='60' r='1.5' fill='white' opacity='0.5'/%3E%3Ccircle cx='60' cy='10' r='1.5' fill='white' opacity='0.5'/%3E%3Cpath d='M70 60 L71 63 L74 63 L71.5 65 L72.5 68 L70 66 L67.5 68 L68.5 65 L66 63 L69 63 Z' fill='%23fff176' transform='scale(0.8)'/%3E%3C/svg%3E`
            },
            {
                id: 'leopard-chic',
                name: 'Wild Side',
                // Beige animal print
                src: `data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='100' height='100' fill='%23d7ccc8'/%3E%3Cpath d='M20 20 Q25 15 30 20 Q30 25 25 25 Q20 25 20 20' fill='%235d4037'/%3E%3Cpath d='M60 40 Q65 35 70 45 Q60 55 55 45' fill='%235d4037'/%3E%3Cpath d='M10 70 Q15 65 20 75 Q15 85 10 75' fill='%235d4037'/%3E%3Cpath d='M80 80 Q90 75 95 85 Q90 95 80 90' fill='%235d4037'/%3E%3Ccircle cx='45' cy='25' r='3' fill='%238d6e63'/%3E%3Ccircle cx='75' cy='60' r='3' fill='%238d6e63'/%3E%3C/svg%3E`
            },

            // --- MINIMALIST ---
            {
                id: 'sage-grid',
                name: 'Sage Graph',
                // Aesthetic green grid
                src: `data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='40' height='40' fill='%23f1f8e9'/%3E%3Cpath d='M0 0 L40 0' stroke='%23a5d6a7' stroke-width='1'/%3E%3Cpath d='M0 0 L0 40' stroke='%23a5d6a7' stroke-width='1'/%3E%3C/svg%3E`
            },
            {
                id: 'organic-shapes',
                name: 'Matisse',
                // Abstract organic blobs
                src: `data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='100' height='100' fill='%23fff3e0'/%3E%3Cpath d='M10 20 Q30 0 50 20 T90 20' fill='none' stroke='%23ffab91' stroke-width='4' stroke-linecap='round'/%3E%3Cpath d='M20 60 Q40 40 60 60 T90 50' fill='none' stroke='%2380cbc4' stroke-width='4' stroke-linecap='round'/%3E%3Ccircle cx='30' cy='80' r='5' fill='%23ffab91'/%3E%3C/svg%3E`
            },
            {
                id: 'cyber-glitch',
                name: 'Cyberpunk',
                // Black with neon green digital rain feel
                src: `data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='60' height='60' fill='%23111'/%3E%3Crect x='10' y='10' width='5' height='15' fill='%230f0' opacity='0.7'/%3E%3Crect x='30' y='30' width='5' height='10' fill='%230f0' opacity='0.5'/%3E%3Crect x='50' y='5' width='5' height='20' fill='%230f0' opacity='0.3'/%3E%3Crect x='20' y='50' width='5' height='5' fill='%230f0' opacity='0.9'/%3E%3C/svg%3E`
            }
        ];

        /* --- STATE & VARIABLES --- */
        const state = {
            currentLayout: 'strip', // strip, grid, single
            currentFilter: 'sepia',
            currentFrameId: 'simple-white', 
            photos: [], // Stores temp blobs for current session
            isCapturing: false
        };

        const elements = {
            video: document.getElementById('webcam'),
            viewfinder: document.getElementById('viewfinder'),
            canvas: document.getElementById('resultCanvas'),
            flash: document.getElementById('flash'),
            countdown: document.getElementById('countdown'),
            galleryGrid: document.getElementById('gallery-grid'),
            frameOptionsContainer: document.getElementById('frame-options-container')
        };

        const ctx = elements.canvas.getContext('2d');
        let stream = null;

        /* --- INIT --- */
        function initFrameOptions() {
            elements.frameOptionsContainer.innerHTML = '';
            frameAssets.forEach((frame, index) => {
                const checked = index === 0 ? 'checked' : '';
                
                // Create the radio input
                const input = document.createElement('input');
                input.type = 'radio';
                input.name = 'frame';
                input.id = `frame-${frame.id}`;
                input.className = 'frame-radio';
                input.value = frame.id;
                if(index === 0) input.checked = true;
                input.onchange = () => setFrame(frame.id);

                // Create the label (preview)
                const label = document.createElement('label');
                label.htmlFor = `frame-${frame.id}`;
                label.className = 'frame-label';
                label.title = frame.name;
                // Use the SVG data URI as the background for the preview circle
                label.style.backgroundImage = `url("${frame.src}")`;

                elements.frameOptionsContainer.appendChild(input);
                elements.frameOptionsContainer.appendChild(label);
            });
        }

        /* --- NAVIGATION --- */
        function navTo(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId + '-page').classList.add('active');
            
            // Update nav links
            document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
            if(pageId === 'home') document.querySelector('nav a[onclick="navTo(\'home\')"]').classList.add('active');
            if(pageId === 'about') document.querySelector('nav a[onclick="navTo(\'about\')"]').classList.add('active');
            
            if(pageId === 'booth') {
                document.querySelector('nav a[onclick="navTo(\'booth\')"]').classList.add('active');
                startCamera();
            } else {
                stopCamera();
            }
            if(pageId === 'gallery') {
                document.querySelector('nav a[onclick="navTo(\'gallery\')"]').classList.add('active');
                loadGallery();
            }
        }

        /* --- CAMERA LOGIC --- */
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { width: 720, height: 720 }, audio: false });
                elements.video.srcObject = stream;
            } catch (err) {
                alert("Camera access denied or not available. Please allow camera permissions.");
                console.error(err);
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }

        function setLayout(layout) {
            state.currentLayout = layout;
            document.querySelectorAll('.layout-options .option-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById('btn-' + layout).classList.add('selected');
        }

        function setFilter(filter) {
            state.currentFilter = filter;
            elements.viewfinder.classList.remove('filter-sepia', 'filter-bw', 'filter-vintage', 'filter-none', 'filter-warm');
            elements.viewfinder.classList.add('filter-' + filter);
            
            document.querySelectorAll('.filter-options .option-btn').forEach(b => b.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        function setFrame(id) {
            state.currentFrameId = id;
        }

        /* --- CAPTURE SEQUENCE --- */
        async function startCaptureSequence() {
            if(state.isCapturing) return;
            state.isCapturing = true;
            state.photos = [];

            let shotsNeeded = 1;
            if (state.currentLayout === 'strip') shotsNeeded = 3;
            if (state.currentLayout === 'grid') shotsNeeded = 4;

            for (let i = 0; i < shotsNeeded; i++) {
                await runCountdown(3);
                triggerFlash();
                const shot = captureFrame();
                state.photos.push(shot);
                if (i < shotsNeeded - 1) await new Promise(r => setTimeout(r, 1000));
            }

            await renderFinalComposition();
            navTo('result');
            state.isCapturing = false;
        }

        function runCountdown(seconds) {
            return new Promise(resolve => {
                let count = seconds;
                elements.countdown.style.display = 'block';
                
                const tick = () => {
                    elements.countdown.innerText = count;
                    elements.countdown.classList.remove('count-anim');
                    void elements.countdown.offsetWidth; // Trigger reflow
                    elements.countdown.classList.add('count-anim');

                    if (count === 0) {
                        elements.countdown.style.display = 'none';
                        resolve();
                    } else {
                        count--;
                        setTimeout(tick, 1000);
                    }
                };
                tick();
            });
        }

        function triggerFlash() {
            elements.flash.classList.add('flash-active');
            setTimeout(() => elements.flash.classList.remove('flash-active'), 400);
        }

        function captureFrame() {
            const offCanvas = document.createElement('canvas');
            offCanvas.width = elements.video.videoWidth;
            offCanvas.height = elements.video.videoHeight;
            const offCtx = offCanvas.getContext('2d');
            
            // Mirror logic
            offCtx.translate(offCanvas.width, 0);
            offCtx.scale(-1, 1);
            offCtx.drawImage(elements.video, 0, 0);
            return offCanvas;
        }

        /* --- COMPOSITION & RENDERING --- */
        async function renderFinalComposition() {
            const photos = state.photos;
            const layout = state.currentLayout;
            
            // Find current frame asset
            const frameObj = frameAssets.find(f => f.id === state.currentFrameId) || frameAssets[0];
            
            const photoW = 300;
            const photoH = 300; 
            const padding = 30;
            const footerHeight = 80;

            let canvasW, canvasH;

            // Calculate Canvas Size
            if (layout === 'single') {
                canvasW = photoW + (padding * 2);
                canvasH = photoH + (padding * 2) + footerHeight;
            } else if (layout === 'strip') {
                canvasW = photoW + (padding * 2);
                canvasH = (photoH * 3) + (padding * 4) + footerHeight;
            } else if (layout === 'grid') {
                canvasW = (photoW * 2) + (padding * 3);
                canvasH = (photoH * 2) + (padding * 3) + footerHeight;
            }

            elements.canvas.width = canvasW;
            elements.canvas.height = canvasH;

            // --- DRAW BACKGROUND IMAGE (FRAME PATTERN) ---
            // We use a pattern repeat for the background
            try {
                const bgPattern = await loadPattern(frameObj.src);
                ctx.fillStyle = ctx.createPattern(bgPattern, 'repeat');
                ctx.fillRect(0, 0, canvasW, canvasH);
            } catch (e) {
                // Fallback
                console.error("Pattern load failed", e);
                ctx.fillStyle = '#fdfbf7';
                ctx.fillRect(0, 0, canvasW, canvasH);
            }
            
            // Apply Global Filter to Context before drawing images
            applyContextFilter();

            // Draw Photos
            if (layout === 'single') {
                ctx.drawImage(photos[0], padding, padding, photoW, photoH);
                drawPhotoBorder(padding, padding, photoW, photoH);
            } 
            else if (layout === 'strip') {
                let y = padding;
                photos.forEach(photo => {
                    ctx.drawImage(photo, padding, y, photoW, photoH);
                    drawPhotoBorder(padding, y, photoW, photoH);
                    y += photoH + padding;
                });
            } 
            else if (layout === 'grid') {
                const positions = [
                    { x: padding, y: padding },
                    { x: padding*2 + photoW, y: padding },
                    { x: padding, y: padding*2 + photoH },
                    { x: padding*2 + photoW, y: padding*2 + photoH }
                ];
                photos.forEach((photo, i) => {
                    if(positions[i]) {
                        ctx.drawImage(photo, positions[i].x, positions[i].y, photoW, photoH);
                        drawPhotoBorder(positions[i].x, positions[i].y, photoW, photoH);
                    }
                });
            }

             // Reset Filter for Text
            //  ctx.filter = 'none';

            //  // Add Footer Date
            //  ctx.font = 'bold 16px "Playfair Display"';
            //  ctx.textAlign = 'center';
             
            //  // Smart text color based on frame ID
            //  if(frameObj.id === 'dark-film') ctx.fillStyle = '#aaa';
            //  else ctx.fillStyle = '#333';

            //  const dateStr = new Date().toLocaleDateString();
            //  const footerY = canvasH - (footerHeight/2) + 8;
            //  ctx.fillText(`RETRO BOOTH  ${dateStr}`, canvasW / 2, footerY);

            // Add Grain Overlay
            addNoiseToCanvas();
        }

        // Helper to load image for pattern
        function loadPattern(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = src;
            });
        }

        function applyContextFilter() {
            const f = state.currentFilter;
            if (f === 'sepia') ctx.filter = 'sepia(0.6) contrast(1.1) brightness(0.95)';
            else if (f === 'bw') ctx.filter = 'grayscale(1) contrast(1.2)';
            else if (f === 'vintage') ctx.filter = 'sepia(0.4) grayscale(0.2) contrast(1.1)';
            else ctx.filter = 'none';
        }

        function drawPhotoBorder(x, y, w, h) {
            // Inner border for photo definition
            ctx.strokeStyle = 'rgba(0,0,0,0.1)';
            ctx.lineWidth = 1;
            ctx.strokeRect(x, y, w, h);
        }

        function addNoiseToCanvas() {
            const w = elements.canvas.width;
            const h = elements.canvas.height;
            const iData = ctx.getImageData(0, 0, w, h);
            const data = iData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const noise = (Math.random() - 0.5) * 15;
                data[i] += noise;
                data[i+1] += noise;
                data[i+2] += noise;
            }
            ctx.putImageData(iData, 0, 0);
        }

        /* --- POST-PROCESS & SAVING --- */
        function retake() {
            navTo('booth');
        }

        function downloadImage() {
            const link = document.createElement('a');
            link.download = `retro-booth-${Date.now()}.png`;
            link.href = elements.canvas.toDataURL('image/png');
            link.click();
        }

        function saveToGallery() {
            const dataUrl = elements.canvas.toDataURL('image/png');
            const saved = JSON.parse(localStorage.getItem('retroPhotos') || '[]');
            
            saved.unshift({
                id: Date.now(),
                data: dataUrl,
                date: new Date().toLocaleDateString()
            });
            
            localStorage.setItem('retroPhotos', JSON.stringify(saved));
            alert("Saved to Gallery!");
            navTo('gallery');
        }

        function loadGallery() {
            const saved = JSON.parse(localStorage.getItem('retroPhotos') || '[]');
            elements.galleryGrid.innerHTML = '';

            if(saved.length === 0) {
                elements.galleryGrid.innerHTML = '<p style="grid-column: 1/-1; text-align:center; opacity:0.6;">No photos yet. Go take some!</p>';
                return;
            }

            saved.forEach(item => {
                const div = document.createElement('div');
                div.className = 'gallery-item';
                div.innerHTML = `
                    <button class="delete-btn" onclick="deletePhoto(${item.id})"></button>
                    <img src="${item.data}" alt="Photobooth Strip">
                `;
                div.onclick = (e) => {
                    if(!e.target.classList.contains('delete-btn')) {
                        const link = document.createElement('a');
                        link.download = 'retro-photo.png';
                        // link.href = item.data;
                        link.click();
                    }
                };
                elements.galleryGrid.appendChild(div);
            });
        }

        function deletePhoto(id) {
            if(!confirm('Delete this photo?')) return;
            const saved = JSON.parse(localStorage.getItem('retroPhotos') || '[]');
            const updated = saved.filter(p => p.id !== id);
            localStorage.setItem('retroPhotos', JSON.stringify(updated));
            loadGallery();
        }

        // Init
        initFrameOptions();
        navTo('home');

    </script>
</body>
</html>

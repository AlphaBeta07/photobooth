<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retro Booth | Vintage Analogue Photobooth</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- CSS VARIABLES & THEME --- */
        :root {
            --bg-cream: #F7EFE2;
            --bg-paper: #f0e6d2;
            --sepia-dark: #4e342e;
            --sepia-light: #8d6e63;
            --accent-gold: #c5a059;
            --black-muted: #2c2c2c;
            --film-border: #1a1a1a;
            --shadow-soft: 0 4px 20px rgba(78, 52, 46, 0.15);
            --shadow-hard: 2px 2px 0px rgba(78, 52, 46, 0.3);
            --font-head: 'Playfair Display', serif;
            --font-body: 'Inter', sans-serif;
            --radius: 8px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--bg-cream);
            font-family: var(--font-body);
            color: var(--black-muted);
            overflow-x: hidden;
            min-height: 100vh;
            /* Paper texture effect */
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
        }

        /* --- FILM GRAIN OVERLAY --- */
        .film-grain {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 9999;
            opacity: 0.05;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        /* --- NAVIGATION --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(78, 52, 46, 0.1);
            position: relative;
            background: rgba(247, 239, 226, 0.9);
            backdrop-filter: blur(5px);
            z-index: 100;
        }

        .logo {
            font-family: var(--font-head);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--sepia-dark);
            letter-spacing: -0.02em;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        nav ul {
            display: flex;
            gap: 2rem;
            list-style: none;
        }

        nav a {
            text-decoration: none;
            color: var(--black-muted);
            font-weight: 500;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: color 0.3s;
        }

        nav a:hover, nav a.active { color: var(--sepia-dark); text-decoration: underline; text-decoration-thickness: 2px; text-underline-offset: 4px; }

        .banner {
            background-color: var(--sepia-dark);
            color: var(--bg-cream);
            text-align: center;
            padding: 0.5rem;
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.05em;
        }

        /* --- BUTTONS --- */
        .btn {
            background: var(--sepia-dark);
            color: var(--bg-cream);
            border: none;
            padding: 0.8rem 2rem;
            font-family: var(--font-head);
            font-size: 1.1rem;
            cursor: pointer;
            border-radius: 4px;
            box-shadow: 3px 3px 0px rgba(0,0,0,0.2);
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .btn:active { transform: translate(2px, 2px); box-shadow: 1px 1px 0px rgba(0,0,0,0.2); }
        .btn-outline { background: transparent; border: 2px solid var(--sepia-dark); color: var(--sepia-dark); box-shadow: none; }
        .btn-icon { padding: 0.5rem; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }

        /* --- PAGES --- */
        .page { display: none; padding: 2rem; max-width: 1200px; margin: 0 auto; animation: fadeIn 0.5s ease; }
        .page.active { display: block; }

        /* --- HOME --- */
        .hero { text-align: center; padding: 4rem 1rem; }
        .hero h1 { font-family: var(--font-head); font-size: 4rem; color: var(--sepia-dark); margin-bottom: 1rem; line-height: 1.1; }
        .hero p { font-size: 1.2rem; color: var(--sepia-light); margin-bottom: 3rem; font-style: italic; }
        .polaroid-stack { display: flex; justify-content: center; gap: 1rem; margin-top: 3rem; flex-wrap: wrap; }
        .dummy-polaroid {
            background: white; padding: 10px 10px 30px 10px; width: 150px; height: 180px;
            box-shadow: var(--shadow-soft); transform: rotate(-5deg); border: 1px solid #ddd;
        }
        .dummy-polaroid:nth-child(2) { transform: rotate(3deg); }
        .dummy-polaroid:nth-child(3) { transform: rotate(-2deg); }
        .dummy-inner { background: #333; height: 100%; width: 100%; opacity: 0.8; }

        /* --- BOOTH UI --- */
        .booth-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
            height: 80vh;
        }

        .controls-panel {
            background: white;
            padding: 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-soft);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            border: 1px solid #e0d0b8;
        }

        .control-group h3 { font-family: var(--font-head); margin-bottom: 0.8rem; font-size: 1.2rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem; }
        
        .layout-options, .filter-options { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        
        .option-btn {
            border: 1px solid #ccc; background: #fff; padding: 0.5rem; cursor: pointer; border-radius: 4px; flex: 1; text-align: center;
            font-size: 0.8rem; transition: all 0.2s;
        }
        .option-btn.selected { background: var(--sepia-dark); color: white; border-color: var(--sepia-dark); }
        .option-btn i { font-size: 1.2rem; display: block; margin-bottom: 4px; }

        .viewfinder-area {
            position: relative;
            background: #111;
            border-radius: var(--radius);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
            border: 8px solid #333;
        }

        video {
            width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); /* Mirror */
        }

        /* Video Filters (Preview Only) */
        .filter-sepia video { filter: sepia(0.6) contrast(1.1) brightness(0.9); }
        .filter-bw video { filter: grayscale(1) contrast(1.2); }
        .filter-warm video { filter: sepia(0.3) saturate(1.4) contrast(1.1); }
        .filter-vintage video { filter: sepia(0.4) grayscale(0.2) contrast(1.1) brightness(0.9); }
        .filter-none video { filter: none; }

        .countdown-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-family: var(--font-head); font-size: 8rem; color: white; text-shadow: 0 4px 10px rgba(0,0,0,0.5);
            display: none; pointer-events: none;
        }

        .flash-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white;
            opacity: 0; pointer-events: none;
        }

        .camera-actions {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 10;
        }
        
        .shutter-btn {
            width: 70px; height: 70px; border-radius: 50%; background: #c62828; border: 4px solid white;
            box-shadow: 0 0 20px rgba(0,0,0,0.5); cursor: pointer; transition: transform 0.1s;
        }
        .shutter-btn:active { transform: translateX(-50%) scale(0.9); }

        /* --- RESULT/GALLERY --- */
        .result-container { text-align: center; }
        .result-stage {
            max-width: 600px; margin: 0 auto; background: #eee; padding: 20px;
            box-shadow: var(--shadow-soft); transform: rotate(1deg); background-image: url("data:image/svg+xml,...");
        }
        #resultCanvas { max-width: 100%; height: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        .gallery-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 2rem; margin-top: 2rem;
        }
        .gallery-item {
            position: relative; background: white; padding: 10px 10px 40px 10px;
            box-shadow: var(--shadow-soft); transition: transform 0.2s;
            cursor: pointer;
        }
        .gallery-item:hover { transform: scale(1.02) rotate(1deg); z-index: 10; }
        .gallery-item img { width: 100%; display: block; filter: contrast(1.05); }
        .gallery-date {
            position: absolute; bottom: 10px; right: 15px; font-family: 'Courier New', monospace;
            font-size: 0.8rem; color: #555; transform: rotate(-2deg);
        }
        .delete-btn {
            position: absolute; top: -10px; right: -10px; background: #c62828; color: white;
            width: 25px; height: 25px; border-radius: 50%; border: none; cursor: pointer; display: none;
        }
        .gallery-item:hover .delete-btn { display: block; }

        /* --- STICKERS --- */
        .sticker-tray {
            display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; border-top: 1px solid #eee; margin-top: auto;
        }
        .sticker-opt { font-size: 1.5rem; cursor: pointer; padding: 5px; opacity: 0.7; transition: opacity 0.2s; }
        .sticker-opt:hover { opacity: 1; transform: scale(1.2); }

        /* --- ABOUT PAGE STYLES --- */
        .about-content {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 3rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-soft);
            border: 1px solid #e0d0b8;
        }
        .about-section { margin-bottom: 2.5rem; }
        .about-section h2 { font-family: var(--font-head); font-size: 2rem; color: var(--sepia-dark); margin-bottom: 1rem; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .about-section p { font-size: 1.05rem; line-height: 1.6; color: var(--black-muted); margin-bottom: 1rem; }
        .feature-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-top: 2rem; }
        .feature-card { text-align: center; padding: 1.5rem; background: var(--bg-cream); border-radius: var(--radius); border: 1px solid rgba(0,0,0,0.05); }
        .feature-card i { font-size: 2rem; color: var(--sepia-light); margin-bottom: 1rem; }
        .feature-card h4 { font-family: var(--font-head); margin-bottom: 0.5rem; font-size: 1.1rem; }
        .feature-card p { font-size: 0.9rem; margin: 0; }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        
        @keyframes flash {
            0% { opacity: 0; } 10% { opacity: 1; } 100% { opacity: 0; }
        }
        .flash-active { animation: flash 0.4s ease-out; }
        
        @keyframes count {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }
        .count-anim { animation: count 0.9s ease-in-out; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            .booth-container { grid-template-columns: 1fr; height: auto; }
            .controls-panel { order: 2; }
            .viewfinder-area { height: 60vh; order: 1; }
            header { flex-direction: column; gap: 1rem; }
            nav ul { gap: 1rem; font-size: 0.8rem; }
            .hero h1 { font-size: 2.5rem; }
            .about-content { padding: 1.5rem; }
        }
    </style>
</head>
<body>

    <div class="film-grain"></div>

    <div class="banner">
        Enjoy your Photobooth
    </div>

    <header>
        <div class="logo">
            <i class="fa-solid fa-camera-retro"></i>
            <span>RETRO BOOTH</span>
        </div>
        <nav>
            <ul>
                <li><a href="#" onclick="navTo('home')" class="active">Home</a></li>
                <li><a href="#" onclick="navTo('booth')">Booth</a></li>
                <li><a href="#" onclick="navTo('gallery')">Gallery</a></li>
                <li><a href="#" onclick="navTo('about')">About</a></li>
            </ul>
        </nav>
    </header>

    <!-- HOME PAGE -->
    <main id="home-page" class="page active">
        <div class="hero">
            <h1>Capture Moments<br>Like It's 1970's.</h1>
            <p>Digital photography with an analogue soul.</p>
            <button class="btn" onclick="navTo('booth')">START BOOTH</button>

            <div class="polaroid-stack">
                <div class="dummy-polaroid"><div class="dummy-inner"></div></div>
                <div class="dummy-polaroid"><div class="dummy-inner"></div></div>
                <div class="dummy-polaroid"><div class="dummy-inner"></div></div>
            </div>
        </div>
    </main>

    <!-- BOOTH PAGE -->
    <main id="booth-page" class="page">
        <div class="booth-container">
            <!-- Sidebar Controls -->
            <div class="controls-panel">
                <div class="control-group">
                    <h3>1. Choose Layout</h3>
                    <div class="layout-options">
                        <div class="option-btn selected" onclick="setLayout('strip')" id="btn-strip">
                            <i class="fa-solid fa-film"></i> Strip
                        </div>
                        <div class="option-btn" onclick="setLayout('grid')" id="btn-grid">
                            <i class="fa-solid fa-border-all"></i> 2x2
                        </div>
                        <div class="option-btn" onclick="setLayout('single')" id="btn-single">
                            <i class="fa-regular fa-image"></i> Single
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <h3>2. Set Filter</h3>
                    <div class="filter-options">
                        <div class="option-btn" onclick="setFilter('none')">Normal</div>
                        <div class="option-btn selected" onclick="setFilter('sepia')">Sepia</div>
                        <div class="option-btn" onclick="setFilter('bw')">B&W</div>
                        <div class="option-btn" onclick="setFilter('vintage')">Vintage</div>
                    </div>
                </div>
            </div>

            <!-- Camera Viewfinder -->
            <div class="viewfinder-area filter-sepia" id="viewfinder">
                <video id="webcam" autoplay playsinline muted></video>
                <div class="flash-overlay" id="flash"></div>
                <div class="countdown-overlay" id="countdown">3</div>
                
                <div class="camera-actions">
                    <button class="shutter-btn" onclick="startCaptureSequence()"></button>
                </div>
            </div>
        </div>
    </main>

    <!-- RESULT PAGE -->
    <main id="result-page" class="page">
        <div class="result-container">
            <h2 style="font-family: var(--font-head); margin-bottom: 1rem;">Your Photo is Ready</h2>
            
            <div class="result-stage">
                <canvas id="resultCanvas"></canvas>
            </div>

            <div class="controls-panel" style="margin-top: 2rem; max-width: auto; margin-left: auto; margin-right: auto;">
                <div style="gap: 10px; text-align: center; margin: 1rem;">
                    <button class="btn btn-outline" onclick="retake()">Retake</button>
                    <button class="btn btn-outline" onclick="downloadImage()">Download</button>
                    <button class="btn btn-outline" onclick="saveToGallery()">Save to Gallery</button>
                </div>
            </div>
        </div>
    </main>

    <!-- GALLERY PAGE -->
    <main id="gallery-page" class="page">
        <h2 style="font-family: var(--font-head); text-align: center;">Photo Archive</h2>
        <div class="gallery-grid" id="gallery-grid">
            <!-- Items injected via JS -->
        </div>
        <div style="text-align: center; margin-top: 3rem;">
            <button class="btn btn-outline" onclick="localStorage.removeItem('retroPhotos'); loadGallery();">Clear All History</button>
        </div>
    </main>

    <!-- ABOUT PAGE -->
    <main id="about-page" class="page">
        <div class="about-content">
            <div class="about-section">
                <h2>Our Story</h2>
                <p>Welcome to Retro Booth. In an age where every photo is instantly editable and perfect, we wanted to bring back the magic of waiting, the charm of imperfection, and the soul of analogue photography.</p>
                <p>Inspired by the classic mall photobooths of the 70s and 80s, this digital experience replicates the grain, the flash, and the spontaneity of the physical booths we all miss.</p>
            </div>

            <div class="about-section">
                <h2>How It Works</h2>
                <div class="feature-grid">
                    <div class="feature-card">
                        <i class="fa-solid fa-camera"></i>
                        <h4>Snap</h4>
                        <p>Choose your layout (strip or grid) and get ready for the flash sequence.</p>
                    </div>
                    <div class="feature-card">
                        <i class="fa-solid fa-wand-magic-sparkles"></i>
                        <h4>Process</h4>
                        <p>We apply our custom film grain and color grading algorithms instantly.</p>
                    </div>
                    <div class="feature-card">
                        <i class="fa-solid fa-download"></i>
                        <h4>Keep</h4>
                        <p>Save your digital strip to your device or keep it in your browser gallery.</p>
                    </div>
                </div>
            </div>

            <div class="about-section" style="border-bottom: none;">
                <h2>Privacy</h2>
                <p><strong>Your photos never leave your device.</strong> All image processing happens locally in your browser. We do not store, upload, or see any of the photos you take here. Your gallery is saved to your browser's local storage.</p>
                <div style="text-align: center; margin-top: 2rem;">
                    <button class="btn" onclick="navTo('booth')">Start Snapping</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        /* --- STATE & VARIABLES --- */
        const state = {
            currentLayout: 'strip', // strip, grid, single
            currentFilter: 'sepia',
            photos: [], // Stores temp blobs for current session
            isCapturing: false
        };

        const elements = {
            video: document.getElementById('webcam'),
            viewfinder: document.getElementById('viewfinder'),
            canvas: document.getElementById('resultCanvas'),
            flash: document.getElementById('flash'),
            countdown: document.getElementById('countdown'),
            galleryGrid: document.getElementById('gallery-grid')
        };

        const ctx = elements.canvas.getContext('2d');
        let stream = null;

        /* --- NAVIGATION --- */
        function navTo(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId + '-page').classList.add('active');
            
            // Update nav links
            document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
            if(pageId === 'home') document.querySelector('nav a[onclick="navTo(\'home\')"]').classList.add('active');
            if(pageId === 'about') document.querySelector('nav a[onclick="navTo(\'about\')"]').classList.add('active');
            
            if(pageId === 'booth') {
                document.querySelector('nav a[onclick="navTo(\'booth\')"]').classList.add('active');
                startCamera();
            } else {
                stopCamera();
            }
            if(pageId === 'gallery') {
                document.querySelector('nav a[onclick="navTo(\'gallery\')"]').classList.add('active');
                loadGallery();
            }
        }

        /* --- CAMERA LOGIC --- */
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { width: 720, height: 720 }, audio: false });
                elements.video.srcObject = stream;
            } catch (err) {
                alert("Camera access denied or not available. Please allow camera permissions.");
                console.error(err);
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }

        function setLayout(layout) {
            state.currentLayout = layout;
            document.querySelectorAll('.layout-options .option-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById('btn-' + layout).classList.add('selected');
        }

        function setFilter(filter) {
            state.currentFilter = filter;
            // Remove old filter classes
            elements.viewfinder.classList.remove('filter-sepia', 'filter-bw', 'filter-vintage', 'filter-none', 'filter-warm');
            // Add new
            elements.viewfinder.classList.add('filter-' + filter);
            
            // Update buttons
            document.querySelectorAll('.filter-options .option-btn').forEach(b => b.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        /* --- CAPTURE SEQUENCE --- */
        async function startCaptureSequence() {
            if(state.isCapturing) return;
            state.isCapturing = true;
            state.photos = [];

            let shotsNeeded = 1;
            if (state.currentLayout === 'strip') shotsNeeded = 3;
            if (state.currentLayout === 'grid') shotsNeeded = 4;

            for (let i = 0; i < shotsNeeded; i++) {
                await runCountdown(3);
                triggerFlash();
                const shot = captureFrame();
                state.photos.push(shot);
                // Small delay between shots
                if (i < shotsNeeded - 1) await new Promise(r => setTimeout(r, 1000));
            }

            renderFinalComposition();
            navTo('result');
            state.isCapturing = false;
        }

        function runCountdown(seconds) {
            return new Promise(resolve => {
                let count = seconds;
                elements.countdown.style.display = 'block';
                
                const tick = () => {
                    elements.countdown.innerText = count;
                    elements.countdown.classList.remove('count-anim');
                    void elements.countdown.offsetWidth; // Trigger reflow
                    elements.countdown.classList.add('count-anim');

                    if (count === 0) {
                        elements.countdown.style.display = 'none';
                        resolve();
                    } else {
                        count--;
                        setTimeout(tick, 1000);
                    }
                };
                tick();
            });
        }

        function triggerFlash() {
            elements.flash.classList.add('flash-active');
            setTimeout(() => elements.flash.classList.remove('flash-active'), 400);
        }

        function captureFrame() {
            // Capture raw frame to an offscreen canvas
            const offCanvas = document.createElement('canvas');
            offCanvas.width = elements.video.videoWidth;
            offCanvas.height = elements.video.videoHeight;
            const offCtx = offCanvas.getContext('2d');
            
            // Mirror logic to match video
            offCtx.translate(offCanvas.width, 0);
            offCtx.scale(-1, 1);
            
            offCtx.drawImage(elements.video, 0, 0);
            return offCanvas;
        }

        /* --- COMPOSITION & RENDERING --- */
        function renderFinalComposition() {
            const photos = state.photos;
            const layout = state.currentLayout;
            
            // Base config
            const photoW = 300;
            const photoH = 300; 
            const padding = 30;
            const border = 15;
            const headerHeight = 0;
            const footerHeight = 80;

            let canvasW, canvasH;

            // Calculate Canvas Size
            if (layout === 'single') {
                canvasW = photoW + (padding * 2);
                canvasH = photoH + (padding * 2) + footerHeight;
            } else if (layout === 'strip') {
                canvasW = photoW + (padding * 2);
                canvasH = (photoH * 3) + (padding * 4) + footerHeight; // 3 photos vertical
            } else if (layout === 'grid') {
                canvasW = (photoW * 2) + (padding * 3);
                canvasH = (photoH * 2) + (padding * 3) + footerHeight;
            }

            elements.canvas.width = canvasW;
            elements.canvas.height = canvasH;

            // Background
            ctx.fillStyle = '#fdfbf7'; // Photo paper white
            ctx.fillRect(0, 0, canvasW, canvasH);
            
            // Apply Global Filter to Context before drawing images
            applyContextFilter();

            // Draw Photos
            if (layout === 'single') {
                ctx.drawImage(photos[0], padding, padding, photoW, photoH);
                drawFrameBorder(padding, padding, photoW, photoH);
            } 
            else if (layout === 'strip') {
                let y = padding;
                photos.forEach(photo => {
                    ctx.drawImage(photo, padding, y, photoW, photoH);
                    drawFrameBorder(padding, y, photoW, photoH);
                    y += photoH + padding;
                });
            } 
            else if (layout === 'grid') {
                // 0 1
                // 2 3
                const positions = [
                    { x: padding, y: padding },
                    { x: padding*2 + photoW, y: padding },
                    { x: padding, y: padding*2 + photoH },
                    { x: padding*2 + photoW, y: padding*2 + photoH }
                ];
                photos.forEach((photo, i) => {
                    if(positions[i]) {
                        ctx.drawImage(photo, positions[i].x, positions[i].y, photoW, photoH);
                        drawFrameBorder(positions[i].x, positions[i].y, photoW, photoH);
                    }
                });
            }

            // Reset Filter for Text/Logo
            // ctx.filter = 'none';

            // // Add Logo/Date Footer
            // ctx.fillStyle = '#333';
            // ctx.font = 'bold 24px "Playfair Display"';
            // ctx.textAlign = 'center';
            // const dateStr = new Date().toLocaleDateString();
            
            // Draw text at bottom
            // const footerY = canvasH - (footerHeight/2) + 8;
            // ctx.fillText(`RETRO BOOTH • ${dateStr}`, canvasW / 2, footerY);

            // Add Grain Overlay (Noise)
            addNoiseToCanvas();
        }

        function applyContextFilter() {
            const f = state.currentFilter;
            if (f === 'sepia') ctx.filter = 'sepia(0.6) contrast(1.1) brightness(0.95)';
            else if (f === 'bw') ctx.filter = 'grayscale(1) contrast(1.2)';
            else if (f === 'vintage') ctx.filter = 'sepia(0.4) grayscale(0.2) contrast(1.1)';
            else ctx.filter = 'none';
        }

        function drawFrameBorder(x, y, w, h) {
            // Optional: Draw a subtle inner shadow or border on the photo itself
            ctx.strokeStyle = 'rgba(0,0,0,0.1)';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, w, h);
        }

        function addNoiseToCanvas() {
            // Generate random noise on top
            const w = elements.canvas.width;
            const h = elements.canvas.height;
            const iData = ctx.getImageData(0, 0, w, h);
            const data = iData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                const noise = (Math.random() - 0.5) * 15; // Noise strength
                data[i] += noise;
                data[i+1] += noise;
                data[i+2] += noise;
            }
            ctx.putImageData(iData, 0, 0);
        }

        /* --- STICKERS --- */
        function addSticker(type) {
            const w = elements.canvas.width;
            const h = elements.canvas.height;
            
            ctx.save();
            ctx.translate(w/2, h/2);
            ctx.rotate((Math.random() - 0.5) * 0.5); // Random tilt
            
            if(type === 'DATE') {
                ctx.font = '20px "Courier New"';
                ctx.fillStyle = '#ff5722';
                ctx.fillText(new Date().toLocaleDateString(), 0, 0);
            } else {
                ctx.font = '60px serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(type, 0, 0);
            }
            
            ctx.restore();
        }

        /* --- POST-PROCESS & SAVING --- */
        function retake() {
            navTo('booth');
        }

        function downloadImage() {
            const link = document.createElement('a');
            link.download = `retro-booth-${Date.now()}.png`;
            link.href = elements.canvas.toDataURL('image/png');
            link.click();
        }

        function saveToGallery() {
            const dataUrl = elements.canvas.toDataURL('image/png');
            const saved = JSON.parse(localStorage.getItem('retroPhotos') || '[]');
            
            saved.unshift({
                id: Date.now(),
                data: dataUrl,
                date: new Date().toLocaleDateString()
            });
            
            localStorage.setItem('retroPhotos', JSON.stringify(saved));
            alert("Saved to Gallery!");
            navTo('gallery');
        }

        function loadGallery() {
            const saved = JSON.parse(localStorage.getItem('retroPhotos') || '[]');
            elements.galleryGrid.innerHTML = '';

            if(saved.length === 0) {
                elements.galleryGrid.innerHTML = '<p style="grid-column: 1/-1; text-align:center; opacity:0.6;">No photos yet. Go take some!</p>';
                return;
            }

            saved.forEach(item => {
                const div = document.createElement('div');
                div.className = 'gallery-item';
                div.innerHTML = `
                    <button class="delete-btn" onclick="deletePhoto(${item.id})">×</button>
                    <img src="${item.data}" alt="Photobooth Strip">
                    
                `;
                div.onclick = (e) => {
                    if(!e.target.classList.contains('delete-btn')) {
                        // View large logic could go here
                        const link = document.createElement('a');
                        link.download = 'retro-photo.png';
                        // link.href = item.data;
                        link.click();
                    }
                };
                elements.galleryGrid.appendChild(div);
            });
        }

        function deletePhoto(id) {
            if(!confirm('Delete this photo?')) return;
            const saved = JSON.parse(localStorage.getItem('retroPhotos') || '[]');
            const updated = saved.filter(p => p.id !== id);
            localStorage.setItem('retroPhotos', JSON.stringify(updated));
            loadGallery();
        }

        // Init
        navTo('home');

    </script>
</body>
</html>
